# Cloudflare Flexible SSL Configuration
# Cloudflare -> Browser: HTTPS
# Cloudflare -> Server: HTTP (Port 80)

<VirtualHost *:80>
    ServerName toto.brandactivation.hk
    ServerAlias www.toto.brandactivation.hk
    
    # Document Root - 指向構建後的前端文件
    DocumentRoot /var/www/toto/dist
    
    # Directory Configuration
    <Directory /var/www/toto/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # React Router 支持 - 所有路由都指向 index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Cloudflare Real IP - 獲取真實客戶端 IP
    <IfModule mod_remoteip.c>
        RemoteIPHeader CF-Connecting-IP
        # 添加 Cloudflare IP 範圍（如果需要）
        # RemoteIPTrustedProxy 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22
    </IfModule>
    
    # API Proxy - 將 /api 請求代理到 Node.js 後端
    ProxyPreserveHost On
    ProxyRequests Off
    
    <Location /api>
        ProxyPass http://localhost:3002/api
        ProxyPassReverse http://localhost:3002/api
        
        # 設置 X-Forwarded-Proto header（用於 Cloudflare Flexible SSL）
        # Cloudflare 使用 CF-Visitor header，但為了兼容性設置為 https
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For "expr=%{REMOTE_ADDR}"
    </Location>
    
    # 靜態文件緩存
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType application/json "access plus 1 hour"
    </IfModule>
    
    # Gzip 壓縮
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>
    
    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Cloudflare Flexible SSL - 設置 Strict-Transport-Security（僅在 HTTPS 時）
    # 由於使用 Flexible SSL，這會在 Cloudflare 層面處理
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/toto_error.log
    CustomLog ${APACHE_LOG_DIR}/toto_access.log combined
</VirtualHost>
