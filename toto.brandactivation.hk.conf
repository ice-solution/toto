# Cloudflare Flexible SSL 配置
# 注意：Cloudflare Flexible 模式下，客戶端到 Cloudflare 是 HTTPS，Cloudflare 到服務器是 HTTP
# 因此只需要配置 HTTP (port 80) virtualhost

<VirtualHost *:80>
    ServerName toto.brandactivation.hk
    ServerAlias www.toto.brandactivation.hk
    
    # 網站根目錄（請根據實際部署路徑修改）
    DocumentRoot /var/www/toto/dist
    
    # 日誌文件位置（使用 %a 來記錄真實客戶端 IP，需要啟用 mod_remoteip）
    LogFormat "%a %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" cloudflare_combined
    ErrorLog ${APACHE_LOG_DIR}/toto.brandactivation.hk_error.log
    CustomLog ${APACHE_LOG_DIR}/toto.brandactivation.hk_access.log cloudflare_combined
    
    # Cloudflare 真實 IP 配置（需要啟用 mod_remoteip）
    # 這會從 Cloudflare 的 CF-Connecting-IP 或 X-Forwarded-For 標頭中獲取真實客戶端 IP
    <IfModule mod_remoteip.c>
        # Cloudflare IPv4 IP 範圍（2024年更新）
        RemoteIPHeader CF-Connecting-IP
        RemoteIPTrustedProxy 173.245.48.0/20
        RemoteIPTrustedProxy 103.21.244.0/22
        RemoteIPTrustedProxy 103.22.200.0/22
        RemoteIPTrustedProxy 103.31.4.0/22
        RemoteIPTrustedProxy 141.101.64.0/18
        RemoteIPTrustedProxy 108.162.192.0/18
        RemoteIPTrustedProxy 190.93.240.0/20
        RemoteIPTrustedProxy 188.114.96.0/20
        RemoteIPTrustedProxy 197.234.240.0/22
        RemoteIPTrustedProxy 198.41.128.0/17
        RemoteIPTrustedProxy 162.158.0.0/15
        RemoteIPTrustedProxy 104.16.0.0/13
        RemoteIPTrustedProxy 104.24.0.0/14
        RemoteIPTrustedProxy 172.64.0.0/13
        RemoteIPTrustedProxy 131.0.72.0/22
        # Cloudflare IPv6 IP 範圍
        RemoteIPTrustedProxy 2400:cb00::/32
        RemoteIPTrustedProxy 2606:4700::/32
        RemoteIPTrustedProxy 2803:f800::/32
        RemoteIPTrustedProxy 2405:b500::/32
        RemoteIPTrustedProxy 2405:8100::/32
        RemoteIPTrustedProxy 2a06:98c0::/29
        RemoteIPTrustedProxy 2c0f:f248::/32
    </IfModule>
    
    # 目錄設置
    <Directory /var/www/toto/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # SPA 路由重寫規則 - 將所有請求重定向到 index.html
        RewriteEngine On
        RewriteBase /
        
        # 如果請求來自 Cloudflare 且是 HTTPS，設置 X-Forwarded-Proto
        RewriteCond %{HTTP:CF-Visitor} '"scheme":"https"'
        RewriteRule .* - [E=HTTPS:on]
        
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # API 和圖片代理配置
    ProxyPreserveHost On
    ProxyRequests Off
    
    # API Proxy - 將 /api 請求代理到 Node.js 後端
    ProxyPass /api/ http://localhost:3002/
    ProxyPassReverse /api/ http://localhost:3002/
    
    # 圖片文件代理 - 將 /images 請求代理到後端（用於運行時上傳的圖片）
    # 這樣 build 後上傳的圖片也可以正常訪問
    # 注意：build 時已存在的圖片會在 dist/images/ 中，優先使用
    # 如果 dist/images/ 中沒有，則從後端的 public/images/ 提供
    ProxyPass /images/ http://localhost:3002/images/
    ProxyPassReverse /images/ http://localhost:3002/images/
    
    # 設置 X-Forwarded-Proto header（用於 Cloudflare Flexible SSL）
    <Location /api>
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-For "expr=%{REMOTE_ADDR}"
    </Location>
    
    <Location /images>
        RequestHeader set X-Forwarded-Proto "https"
    </Location>
    
    # 靜態資源緩存設置
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/pdf "access plus 1 month"
        ExpiresByType text/html "access plus 0 seconds"
    </IfModule>
    
    # Gzip 壓縮
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
    </IfModule>
    
    # 安全標頭和 Cloudflare 相關標頭處理
    <IfModule mod_headers.c>
        # 基本安全標頭
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-XSS-Protection "1; mode=block"
        
        # 處理 Cloudflare 的 X-Forwarded-Proto（如果 Cloudflare 設置了 HTTPS）
        # 這讓應用知道原始請求是 HTTPS
        RequestHeader set X-Forwarded-Proto "https" env=HTTPS
        
        # 如果 Cloudflare 已經設置了 X-Forwarded-Proto，保留它
        RequestHeader set X-Forwarded-Proto "https" "expr=%{HTTP:CF-Visitor} =~ /\"scheme\":\"https\"/"
        
        # 移除可能洩露服務器信息的標頭
        Header unset Server
        Header unset X-Powered-By
    </IfModule>
    
    # 限制直接訪問（可選，只允許來自 Cloudflare 的請求）
    # 如果啟用此選項，請確保 Cloudflare IP 範圍已正確配置
    # <RequireAll>
    #     Require ip 173.245.48.0/20
    #     Require ip 103.21.244.0/22
    #     Require ip 103.22.200.0/22
    #     Require ip 103.31.4.0/22
    #     Require ip 141.101.64.0/18
    #     Require ip 108.162.192.0/18
    #     Require ip 190.93.240.0/20
    #     Require ip 188.114.96.0/20
    #     Require ip 197.234.240.0/22
    #     Require ip 198.41.128.0/17
    #     Require ip 162.158.0.0/15
    #     Require ip 104.16.0.0/13
    #     Require ip 104.24.0.0/14
    #     Require ip 172.64.0.0/13
    #     Require ip 131.0.72.0/22
    # </RequireAll>
</VirtualHost>

